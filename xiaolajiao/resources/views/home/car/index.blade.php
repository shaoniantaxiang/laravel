@extends('home.parent.index')

@section('metalink')
	@include('home.car.metalink')
@endsection


@section('script')
	@include('home.car.script')
@endsection

@section('subject')
	
	<div id="nTalk_post_hiddenElement" style="left: -10px; top: -10px; visibility: hidden; display: none; width: 1px; height: 1px;"></div>
    <div class="login-info-main">
        <div class="login-info-relative">
            <div class="login-info">
                <div class="login-info-icon"></div>
                <ul>
                    <li class="first"><a href="user.php?act=order_list">我的订单</a></li>
                    <li><a href="user.php?act=transform_points">我的积分</a></li>
                    <li><a href="user.php?act=bonus">我的优惠券</a></li>
                    <li class="last"><a href="http://account.xiaolajiao.com/passport.php?act=logout&amp;callback=http%3A%2F%2Fwww.xiaolajiao.com%2Fflow.php">退出登录</a></li>
                </ul>
            </div>
         </div>
    </div>
 
    <div id="xlj_cart_list" class="xlj-cart-main"><div class="xlj-cart-relative">
    <div class="xlj-cart-list">
	<div class="login-info-icon"></div>
		
	<div id="ECS_CARTINFO" class="xlj-cart-list-on">
	    <ul>
						<li>
		    <div class="xlj-cart-list-on-img"><a href="goods-432.html"><img src="http://image.xiaolajiao.com/images/201702/thumb_img/432_thumb_P_1486976698059.jpg?v=20161118" alt="小辣椒K1C 电信版（白色）"></a></div>
		    <div class="xlj-cart-list-on-one">
			<a title="小辣椒K1C 电信版（白色）" href="goods-432.html" class="xlj-cart-list-on-name">小辣椒K1C 电信版（白色）</a>
			<p class="xlj-cart-list-on-price">￥399.00<span>X1</span></p>
		    </div>
		    <div class="xlj-cart-list-on-two">
						<p class="xlj-cart-list-on-color">颜色:白色 
</p>
									<a data-gid="930713" href="javascript:void(0);" class="xlj-cart-list-on-icon">✖ </a>
					    </div>
		</li>
					    </ul>
		
	    <div class="xlj-cart-list-on-buy">
		<p>合计：<br><span>￥399.00元</span></p>
		<a href="flow.php?step=checkout">去结账</a>
	    </div>
	    
	</div>
	
	
	    </div>
</div></div>


<div data-id="0" class="site-header-nav-show nav-show">
	<ul>
		<li>
			<a href="http://www.xiaolajiao.com/goods-432.html"><img src="http://image.xiaolajiao.com/images/upload/image/20170213/20170213173430_21016.png"> 
			<p>
				小辣椒K1C(电信版)
			</p>
<span>¥399</span> </a> 
		</li>
		<li>
			<a href="http://www.xiaolajiao.com/goods-391.html"><img src="http://image.xiaolajiao.com/images/upload/image/20170206/20170206114957_30729.png"> 
			<p>
				小辣椒老人机K2
			</p>
<span>¥459</span> </a> 
		</li>
		<li>
			<a href="http://www.xiaolajiao.com/goods-395.html"><img src="http://image.xiaolajiao.com/images/upload/image/20170210/20170210135612_45031.png"> 
			<p>
				小辣椒PLAYER
			</p>
<span>¥1599</span> </a> 
		</li>
		<li>
			<a href="http://www.xiaolajiao.com/goods-389.html"><img src="http://image.xiaolajiao.com/images/upload/image/20170306/20170306173342_72201.png"> 
			<p>
				小辣椒S33
			</p>
<span>¥1199</span> </a> 
		</li>
		<li>
			<a href="http://www.xiaolajiao.com/goods-414.html"><img src="http://image.xiaolajiao.com/images/upload/image/20161223/20161223103704_22100.png"> 
			<p>
				小辣椒S35
			</p>
<span>¥1599</span> </a> 
		</li>
		<li>
			<a href="http://www.xiaolajiao.com/goods-429.html"><img src="http://image.xiaolajiao.com/images/upload/image/20170221/20170221115442_42920.png"> 
			<p>
				小辣椒S7
			</p>
<span>¥999</span> </a> 
		</li>
	</ul>
</div>
<div data-id="1" class="site-header-nav-show nav-show">
	<ul>
		<li>
			<a href="http://www.xiaolajiao.com/goods-437.html"><img src="http://image.xiaolajiao.com/images/upload/image/20170313/20170313190416_46998.png"> 
			<p>
				红辣椒note4X
			</p>
<span>¥799</span> </a> 
		</li>
		<li>
			<a href="http://www.xiaolajiao.com/goods-423.html"><img src="http://image.xiaolajiao.com/images/upload/image/20161220/20161220105008_87653.png"> 
			<p>
				红辣椒note5
			</p>
<span>¥1199</span> </a> 
		</li>
		<li>
			<a href="http://www.xiaolajiao.com/goods-454.html"><img align="" width="138" height="155" alt="" title="" src="http://image.xiaolajiao.com/images/upload/image/20170420/20170420104247_90947.png"> 
			<p>
				红辣椒Q6
			</p>
<span>¥399</span> </a> 
		</li>
		<li>
			<a href="http://www.xiaolajiao.com/goods-329.html"><img src="http://image.xiaolajiao.com/images/upload/image/20170121/20170121105122_18832.png"> 
			<p>
				红辣椒Note3
			</p>
<span>¥599</span> </a> 
		</li>
		<li>
			<a href="http://www.xiaolajiao.com/goods-345.html"><img src="http://image.xiaolajiao.com/images/upload/image/20170218/20170218115857_18312.png"> 
			<p>
				红辣椒Note3 Pro
			</p>
<span>¥799</span> </a> 
		</li>
		<li>
			<a href="http://www.xiaolajiao.com/goods-348.html"><img src="http://image.xiaolajiao.com/images/upload/image/20170122/20170122172838_79194.png"> 
			<p>
				红辣椒经典一代
			</p>
<span>¥499</span> </a> 
		</li>
	</ul>
</div>

<div class="site-header">
<div class="site-header-relative">

    
    <a href="/home/index/inx"><div class="site-header-logo"></div></a>
    
    
        
    
    
    <div class="site-header-right">
	    <div class="site-header-search hidden">
		<form method="get" action="search.php" class="xlj-search-form clearfix" id="xlj-search">
			<input type="submit" value="" class="search-submit">
			<div class="search-input-box">
				<input type="text" name="keywords" value="" placeholder="" class="search-input">
								<a href="/goods-395.html" class="search-link">小辣椒PLAYER</a>
				<ul>
									<li><a href="/goods-395.html">小辣椒PLAYER</a></li>
									<li><a href="/goods-407.html">小辣椒X7 全网通（金色）</a></li>
								</ul>
						    </div>
		</form>
	    </div>
	    
	    
	    <div class="site-header-cart">
		<a id="minCart" href="/home/car/showinx"><i class="icon2"></i></a>
	    </div>
	    
	    <!-- 显示登录的用户 -->
	    <div class="site-header-login" id="asynlogin">
		<i class="icon3"></i>
		@if(session('homeuser'))
		<p><a href="/home/center/inx" class="user-name">{{ session('homeuser')->username }}</a>|<a href="/home/login/out" class="user-name">退出</a></p>
		@else
		<p><a href="/home/login/inx" class="user-name">登录</a>|<a href="/home/register/inx" class="user-name">注册</a></p>
		@endif
	    </div>
	    <!-- 显示登录的用户 -->
    </div>
    

</div>
</div>
 
 
  <script src="http://theme.xiaolajiao.com/themes/newxlj/script/flow.js?v=20161118" type="text/javascript"></script>
 <div class="container clearfix">
     <div class="shop-cart-box-hd">
         <h2 class="title">我的购物车</h2>
         <p class="tip">全场购物满￥49.00元包邮</p>
     </div>
     <div class="navbar">
            <span class="on">1.我的购物车</span>
            <span>2.填写核对订单信息</span>
            <span>3.成功提交订单</span>
     </div>
     <div class="shop-cart-box-bd">
         
         <table cellspacing="0" cellpadding="0" class="shop-cart-goods">
             <thead>
             <tr>
                 <th class=" col-1">商品名称</th>
                 <th class=" col-2">价格</th>
                 <th class=" col-2">购买数量</th>
                 <th class=" col-2">小计</th>
                 <th class=" col-2">操作</th>
             </tr>
             </thead>
            <tbody>


            @foreach($list as $v)
                            <tr>
                    <td class="col col-1">
                            <div class="g-pic">
                                <a target="_blank" href="goods-432.html"><img border="0" title="小辣椒K1C 电信版（白色）" src="{{ $v->pic_add }}"></a>
                            </div>
                            <div class="g-info">
                             <div class="g-name">
                              <a target="_blank" href="goods-432.html">
                                {{ $v->newtitle }}
</a> 
                                                                </div>
                                                                <div class="g-detail clearfix">
                                    <ul>
                                    	@if($v->gift)
                                    	@foreach(json_decode(\App\Http\Controllers\home\homeIndexController::setscript($v->gift),true) as $val)
                                        <li>
                                            【赠品】{{ $val }}<span class="goods_gift_930713"></span>
                                        </li>
                                        @endforeach
                                        @endif
                                    </ul>
                                </div>
                                                            </div>
                    </td>
                    <td class="col col-2">￥<span>{{ $v->price }}</span></td>
                    <td class="col col-2">
                        <div class="change-goods-num clearfix">
                            <a class="DelNum" onclick="dodelnum(this)" price="{{ $v->price }}" identity="{{ $v->id }}">
                                -
                            </a>
                            <input onfocus="doipgetnum(this)" price="{{ $v->price }}" onblur="doipsetnum(this)" identity="{{ $v->id }}" class="goods-num" value="{{ $v->num }}" tyep="text"/>
                            <a class="AddNum" onclick="doaddnum(this)" price="{{ $v->price }}" identity="{{ $v->id }}">
                                +
                            </a>
                        </div>
                    </td>
                    <td class="col col-2">
                        ￥<em id="goods_subtotal_930713" class="subtotal">{{ $v->num*$v->price }}</em>
                    </td>

                    <!-- 购物车每条信息的 id -->
                    <td class="col col-2">
                    	<a class="good-del" onclick="dodelinfo(this)" identity="{{ $v->id }}">X</a>
                    </td>
                    <!-- 购物车每条信息的 id -->
                </tr>
                @endforeach
                        </tbody>
         </table>
         <div class="total">
             总金额：￥<span id="money"></span>元
                       </div>
         <div class="go-next clearfix">
             <a href="/home/index/inx" class="btn btn-back "> 继续购物 </a>&nbsp;&nbsp;
             <a onclick="submit_carinfo()" class="btn btn-primary">去结账</a>
         </div>
     </div>
  </div>
  <script type="text/javascript" src="/admin/js/jquery-1.8.3.min.js"></script>
<script>
	//页面加载 计算总价
	counttotal();

	//计算总价
	function counttotal(){
		var subtotallist = $('.subtotal');
		var subtotal = 0;
		for (var i = 0; i < subtotallist.length; i++) {
			subtotal+=parseInt($(subtotallist[i]).html());
		};
		$('#money').html(subtotal);
	}

	//删除本条信息
	function dodelinfo(obj){

		$.ajax({
			url:'/home/car/delwhl',
			type:'Get',
			data:{'id':$(obj).attr('identity')},
			success:function(event){
				if(event == 1){
					$(obj).parent().parent().remove();
					counttotal();
				}else{
					alert('删除失败');
				}
			},
		});
	}

	//＋ － 更新购物车和商品表 库存的ajax
	function upnumajax(obj,num,type){//obj,emobj,id,num,type
		// 获取该条购物车信息的id
		var id = $(obj).attr('identity');
		//小计的标签
		var emobj = $(obj).parent().parent().next('td').find('em');

		$.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });
		$.ajax({
			url:'/home/car/delns',
			data:{'id':id,'num':num,'type':type},
			type:'Post',
			async:false,
			success:function(event){
				if(event == '增加'){
					$(obj).next('input').val(num);
					emobj.html(parseInt($(obj).attr('price'))*num);
				}else if(event == '减少'){
					$(obj).prev('input').val(num);
					emobj.html(parseInt($(obj).attr('price'))*num);
				}else{
					alert('最大库存');
				}
			},
		});
	}

	//减商品数量
	function dodelnum(obj){
		//商品数量
		var num = $(obj).next('input').val();
		num--;
		if(num>=1){
			upnumajax($(obj),num,'del');
		}
		counttotal();
	}

	//增加商品数量
	function doaddnum(obj){
		//商品数量
		var num = $(obj).prev('input').val();
		num++;
		upnumajax($(obj),num,'add');
		counttotal();
	}


	
	//直接输入商品数量。
	var oldnum;
	function doipgetnum(obj){
		oldnum = $(obj).val();
	}

	function doipsetnum(obj){
		var id = $(obj).attr('identity');
		var nownum = $(obj).val();
		if(nownum<=0){
			$(obj).val(1);
			noewnum = 1;
		}
		if(oldnum != nownum){
			$.ajaxSetup({
	            headers: {
	                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
	            }
	        });
			$.ajax({
				url:'/home/car/ipns',
				type:'Post',
				data:{'id':id,'oldnum':oldnum,'nownum':nownum},
				async:false,
				success:function(event){
					if(event == '正常'){
						$(obj).val(nownum);
						$(obj).parent().parent().next('td').find('em').html(parseInt($(obj).attr('price'))*parseInt(nownum));
					}else{
						$(obj).val(event);
						$(obj).parent().parent().next('td').find('em').html(parseInt($(obj).attr('price'))*parseInt(event));
						alert('最大库存'+event);
					}
				},
			});
			counttotal();
		}
	}

	//提交信息给订单
	function submit_carinfo(){
		var carlist = $('.good-del');
		if(carlist.length > 0){
			var str = '';
			for (var i = 0; i < carlist.length; i++) {
				str += $(carlist[i]).attr('identity')+';';
			};
			$.ajaxSetup({
	            headers: {
	                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
	            }
	        });
			$.ajax({
				url:'/home/order/sto',
				data:{'id':str},
				type:'Post',
				success:function(event){
					window.location.href="/home/order/inx/"+event;
				},
			});
		}
	}
</script>
@endsection  


